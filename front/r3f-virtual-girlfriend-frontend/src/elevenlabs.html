<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Demo TTS con ElevenLabs (solo cliente)</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --soft:#1f2937; --text:#e5e7eb; --muted:#9ca3af; --acc:#22d3ee; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Helvetica,Arial,sans-serif;background:linear-gradient(120deg,#0b1025,#0b122d 60%,#0e1a32);color:var(--text)}
    .wrap{max-width:920px;margin:40px auto;padding:24px}
    .card{background:rgba(255,255,255,0.04);backdrop-filter: blur(8px);border:1px solid rgba(255,255,255,0.08);border-radius:18px;padding:22px}
    h1{font-weight:750;font-size:clamp(20px,3vw,30px);margin:0 0 6px}
    p.lead{margin:0 0 18px;color:var(--muted)}
    label{display:block;margin:12px 0 6px;font-weight:600;color:#d1d5db}
    input, select, textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #253046;background:#0b1224;color:var(--text);outline:none}
    input:focus, textarea:focus, select:focus{border-color:var(--acc);box-shadow:0 0 0 3px rgba(34,211,238,.15)}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    .btns{display:flex;gap:12px;flex-wrap:wrap;margin-top:16px}
    button{background:var(--acc);color:#0b1224;border:0;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    button.secondary{background:#253046;color:var(--text)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .slider{display:flex;gap:10px;align-items:center}
    input[type=range]{width:100%}
    .audio{margin-top:16px;display:flex;flex-direction:column;gap:8px}
    .pill{display:inline-flex;gap:8px;align-items:center;background:#0b1224;border:1px solid #253046;padding:8px 12px;border-radius:999px;color:var(--muted);font-size:12px}
    .hint{color:#94a3b8;font-size:12px;margin-top:6px}
    details{margin-top:8px}
    .progress{height:8px;background:#111827;border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0;background:var(--acc)}
    footer{opacity:.7;font-size:12px;margin-top:20px}
    @media (max-width:900px){.col-6,.col-4,.col-3{grid-column:span 12}}
    code{background:#0b1224;border:1px solid #253046;border-radius:8px;padding:2px 6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Generar voz a partir de texto con la API de ElevenLabs</h1>
      <p class="lead">Demo mínima en HTML + JS del lado del cliente. Úsala solo para pruebas locales: <strong>no expongas tu API key en producción</strong>.</p>

      <div class="row">
        <div class="col-6">
          <label>API Key de ElevenLabs</label>
          <input id="apiKey" type="password" placeholder="xi-api-key" autocomplete="off" />
          <div class="hint">Se envía en los headers. En producción, usa un proxy/servidor.</div>
        </div>
        <div class="col-6">
          <label>Voice ID</label>
          <input id="voiceId" type="text" placeholder="p. ej. 21m00Tcm4TlvDq8ikWAM (Rachel)" />
          <div class="hint">Copia el <em>Voice ID</em> desde tu panel de ElevenLabs.</div>
        </div>
        <div class="col-6">
          <label>Modelo</label>
          <select id="model">
            <option value="eleven_multilingual_v2">eleven_multilingual_v2 (recomendado)</option>
            <option value="eleven_monolingual_v1">eleven_monolingual_v1</option>
          </select>
        </div>
        <div class="col-6">
          <label>Formato de salida</label>
          <select id="format">
            <option value="audio/mpeg">audio/mpeg (.mp3)</option>
            <option value="audio/wav">audio/wav</option>
            <option value="audio/ogg">audio/ogg</option>
          </select>
        </div>
      </div>

      <label>Texto a convertir</label>
      <textarea id="text" rows="5" placeholder="Escribe aquí el texto que quieres convertir a voz..."></textarea>

      <div class="row">
        <div class="col-4">
          <label>Stability</label>
          <div class="slider"><input id="stability" type="range" min="0" max="1" step="0.05" value="0.5"><span id="stabilityVal">0.50</span></div>
        </div>
        <div class="col-4">
          <label>Similarity Boost</label>
          <div class="slider"><input id="similarity" type="range" min="0" max="1" step="0.05" value="0.75"><span id="similarityVal">0.75</span></div>
        </div>
        <div class="col-4">
          <label>Style</label>
          <div class="slider"><input id="style" type="range" min="0" max="1" step="0.05" value="0.0"><span id="styleVal">0.00</span></div>
        </div>
      </div>
      <label class="pill"><input id="boost" type="checkbox" checked> use_speaker_boost</label>

      <div class="btns">
        <button id="synthesize">Generar audio</button>
        <button class="secondary" id="cancel" disabled>Cancelar</button>
      </div>

      <div class="progress" aria-hidden="true" style="margin-top:14px"><div class="bar" id="bar"></div></div>

      <div class="audio" id="audioWrap" hidden>
        <audio id="player" controls></audio>
        <div>
          <a id="download" class="pill" href="#" download>Descargar archivo</a>
          <span id="filesize" class="pill"></span>
        </div>
      </div>

      <details>
        <summary>Ver request</summary>
        <pre><code>POST https://api.elevenlabs.io/v1/text-to-speech/&lt;VOICE_ID&gt;
Accept: audio/mpeg
Content-Type: application/json
xi-api-key: &lt;TU_API_KEY&gt;
{
  "text": "...",
  "model_id": "eleven_multilingual_v2",
  "voice_settings": {
    "stability": 0.5,
    "similarity_boost": 0.75,
    "style": 0.0,
    "use_speaker_boost": true
  }
}</code></pre>
      </details>

      <footer>
        Consejo: divide textos largos en frases y genera por partes si tu navegador queda sin memoria.
      </footer>
    </div>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);
    const ui = {
      apiKey: $('#apiKey'),
      voiceId: $('#voiceId'),
      model: $('#model'),
      format: $('#format'),
      text: $('#text'),
      stability: $('#stability'),
      similarity: $('#similarity'),
      style: $('#style'),
      boost: $('#boost'),
      synth: $('#synthesize'),
      cancel: $('#cancel'),
      player: $('#player'),
      audioWrap: $('#audioWrap'),
      download: $('#download'),
      filesize: $('#filesize'),
      bar: $('#bar'),
      stabilityVal: $('#stabilityVal'),
      similarityVal: $('#similarityVal'),
      styleVal: $('#styleVal')
    };

    // Mostrar valores de sliders
    ['stability','similarity','style'].forEach(k=>{
      const el = ui[k];
      const label = ui[k+'Val'];
      const update = ()=> label.textContent = Number(el.value).toFixed(2);
      el.addEventListener('input', update);
      update();
    });

    const endpoint = (voiceId) => `https://api.elevenlabs.io/v1/text-to-speech/${encodeURIComponent(voiceId)}`;

    let controller = null;

    function setWorking(working){
      ui.synth.disabled = working;
      ui.cancel.disabled = !working;
      ui.bar.style.width = working ? '25%' : '0%';
    }

    ui.cancel.addEventListener('click', ()=>{
      if(controller){ controller.abort(); }
    });

    ui.synth.addEventListener('click', async ()=>{
      const key = ui.apiKey.value.trim();
      const voice = ui.voiceId.value.trim();
      const text = ui.text.value.trim();
      if(!key || !voice || !text){
        alert('Introduce API key, Voice ID y texto.');
        return;
      }

      setWorking(true);
      controller = new AbortController();
      const fmt = ui.format.value;

      try{
        const res = await fetch(endpoint(voice), {
          method: 'POST',
          signal: controller.signal,
          headers: {
            'Accept': fmt,
            'Content-Type': 'application/json',
            'xi-api-key': key
          },
          body: JSON.stringify({
            text,
            model_id: ui.model.value,
            voice_settings: {
              stability: Number(ui.stability.value),
              similarity_boost: Number(ui.similarity.value),
              style: Number(ui.style.value),
              use_speaker_boost: ui.boost.checked
            }
          })
        });

        if(!res.ok){
          const msg = await safeReadError(res);
          throw new Error(`HTTP ${res.status} – ${msg}`);
        }

        ui.bar.style.width = '60%';
        const blob = await res.blob();
        ui.bar.style.width = '100%';

        const url = URL.createObjectURL(blob);
        ui.player.src = url;
        ui.audioWrap.hidden = false;

        const ext = fmt.split('/')[1] || 'audio';
        ui.download.href = url;
        ui.download.download = `tts.${ext}`;
        ui.filesize.textContent = humanBytes(blob.size);

        ui.player.play().catch(()=>{});
      } catch(err){
        if(err.name === 'AbortError'){
          alert('Solicitud cancelada.');
        } else {
          console.error(err);
          alert('Error al generar audio: ' + err.message);
        }
      } finally {
        setWorking(false);
        setTimeout(()=> ui.bar.style.width = '0%', 400);
      }
    });

    function humanBytes(n){
      if(!n && n !== 0) return '';
      const u = ['B','KB','MB','GB'];
      let i=0; while(n>1024 && i<u.length-1){n/=1024;i++;}
      return `${n.toFixed(1)} ${u[i]}`;
    }

    async function safeReadError(res){
      try{ return (await res.json()).detail || res.statusText; }
      catch{ try{ return await res.text(); } catch{ return res.statusText; } }
    }
  </script>
</body>
</html>